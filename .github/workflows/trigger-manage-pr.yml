name: Trigger Manage PR

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to create PR for (owner/repo format)'
        required: true
        type: string
      template:
        description: 'Name of the template'
        required: true
        type: string
      parameter_data:
        description: 'Optional parameter data to pass to the template'
        required: false
        type: string
      pr_mode:
        description: 'PR mode for handling existing PRs'
        required: false
        type: string
        default: 'recreate'

  repository_dispatch:
    types: [trigger-manage-pr]

jobs:
  trigger-manage-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Validate repository input
        id: validate
        run: |
          REPO="${{ github.event.inputs.repository || github.event.client_payload.repository }}"
          echo "Repository: $REPO"
          
          # Validate format (owner/repo)
          if [[ ! "$REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "Error: Invalid repository format. Expected: owner/repo"
            exit 1
          fi
          
          echo "repository=$REPO" >> $GITHUB_OUTPUT

      - name: Validate template input
        id: validate_template
        run: |
          TEMPLATE="${{ github.event.inputs.template || github.event.client_payload.template }}"
          echo "Template: $TEMPLATE"
          
          if [[ -z "$TEMPLATE" ]]; then
            echo "Error: Template is required"
            exit 1
          fi
          
          echo "template=$TEMPLATE" >> $GITHUB_OUTPUT

      - name: Trigger manage-pr workflow
        run: |
          REPO="${{ steps.validate.outputs.repository }}"
          TEMPLATE="${{ steps.validate_template.outputs.template }}"
          PARAM_DATA="${{ github.event.inputs.parameter_data || github.event.client_payload.parameter_data || '' }}"
          PR_MODE="${{ github.event.inputs.pr_mode || github.event.client_payload.pr_mode || 'recreate' }}"
          
          echo "Triggering manage-pr workflow for: $REPO"
          echo "Template: $TEMPLATE"
          echo "Parameter data: $PARAM_DATA"
          echo "PR mode: $PR_MODE"
          
          # Build the JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg repo "$REPO" \
            --arg template "$TEMPLATE" \
            --arg param_data "$PARAM_DATA" \
            --arg pr_mode "$PR_MODE" \
            '{
              ref: "main",
              inputs: {
                repository_url: $repo,
                template: $template,
                parameter_data: $param_data,
                pr_mode: $pr_mode
              }
            }')
          
          echo "JSON Payload:"
          echo "$JSON_PAYLOAD"
          
          # Trigger the workflow in manage-prs repository
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}" \
            https://api.github.com/repos/iobroker-bot-orga/manage-prs/actions/workflows/processRepository.yml/dispatches \
            -d "$JSON_PAYLOAD"
          
          echo "Workflow trigger request sent successfully"
